<script>
  const premios = [
    "10% OFF",
    "BATIDO GRATIS",
    "UPGRADE PROTE√çNA",
    "2X1",
    "SIGUE CUID√ÅNDOTE"
  ];

  const centrosSegmentos = [36, 108, 180, 252, 324];

  function normalizarCodigo(valor) {
    return valor.toUpperCase().trim();
  }

  async function girar() {
    const input = document.getElementById("codigo");
    const codigo = normalizarCodigo(input.value);
    const wheel = document.getElementById("wheel");
    const resultado = document.getElementById("resultado");

    if (!codigo) {
      resultado.innerText = "‚ö†Ô∏è Ingresa un c√≥digo";
      return;
    }

    // UI: estado verificando
    resultado.innerHTML = `<span class="loading">‚è≥ Verificando c√≥digo...</span>`;

    try {
      const response = await fetch(
        "https://flpzz.app.n8n.cloud/webhook-test/ruleta-validar",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            codigo: codigo
          })
        }
      );

      const data = await response.json();

      // ‚ùå C√≥digo inv√°lido
      if (!data.ok) {
        resultado.innerText = "‚ùå C√≥digo inv√°lido o ya expirado";
        return;
      }

      // ‚úÖ C√≥digo v√°lido
      const premio = data.premio;
      const indicePremio = premios.indexOf(premio);

      if (indicePremio === -1) {
        resultado.innerText = "‚ö†Ô∏è Premio no v√°lido";
        return;
      }

      const anguloDelPremio = centrosSegmentos[indicePremio];
      const rotacionNecesaria = 180 - anguloDelPremio;
      const vueltas = 5 + Math.floor(Math.random() * 3);
      const anguloFinal = vueltas * 360 + rotacionNecesaria;

      wheel.style.transform = `rotate(${anguloFinal}deg)`;

      setTimeout(() => {
        if (premio === "SIGUE CUID√ÅNDOTE") {
          resultado.innerText = "üíö ¬°Sigue intent√°ndolo!";
        } else {
          resultado.innerText = `üéâ ¬°Ganaste: ${premio}!`;
        }
      }, 4200);

    } catch (error) {
      resultado.innerText = "‚ö†Ô∏è Error de conexi√≥n, intenta nuevamente";
    }
  }
</script>
